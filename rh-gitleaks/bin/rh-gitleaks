#! /bin/bash
set -euo pipefail

config_dir="${XDG_CONFIG_HOME:-${HOME}/.config}/rh-gitleaks"
cache_dir="${XDG_CACHE_HOME:-${HOME}/.cache}/rh-gitleaks"
auth_token_path="${config_dir}/auth.jwt"
gitleaks_version="7.6.1"
gitleaks_bin_path="${cache_dir}/gitleaks-${gitleaks_version}"
gitleaks_patterns_path="${cache_dir}/patterns.toml"
patterns_server="${RH_GITLEAKS_PATTERNS_SERVER:-https://patterns.security.redhat.com}"
refresh_interval_min='720'

function log {
  echo "$(date +"%Y-%m-%dT%H:%M:%S") [$1] $2" >&2
}

function error {
  log "ERROR" "$1"
}

function info {
  log "INFO" "$1"
}

function warn {
  log "WARN" "$1"
}

function debug {
  log "DEBUG" "$1"
}

function os-and-arch {
  case "${OSTYPE}" in
    linux*)
      echo -n "linux-"
    ;;
    darwin*)
      echo -n "darwin-"
    ;;
    *)
      error "Unrecognized OS: OSTYPE=${OSTYPE}"
      exit 1
    ;;
  esac

  case "$(uname -m)" in
    x86_64)
      echo -n "amd64"
    ;;
    *)
      error "Unrecognized Arch: arch=$(uname -m)"
      exit 1
    ;;
  esac
}

function verify-checksum {
  checksum_file="$(mktemp)"
  # This needs to be two spaces between the checksum and the fil for Mac's
  # shasum command to work
  echo "$(gitleaks-checksum)  ${gitleaks_bin_path}" > "${checksum_file}"

  case "${OSTYPE}" in
    linux*)
      sha256sum -c "${checksum_file}"
    ;;
    darwin*)
      shasum -a 256 -c "${checksum_file}"
    ;;
    *)
      error "Unrecognized OS: OSTYPE=${OSTYPE}"
      exit 1
    ;;
  esac
}

function gitleaks-checksum {
  case "$(os-and-arch)-${gitleaks_version}" in
    linux-amd64-7.6.1)
      echo -n "ab3d667982b2bfb00e846bd7b751c640216d2bbe0f71e2c53c4514ca415d99ec"
    ;;
    darwin-amd64-7.6.1)
      echo -n "5e51a33beb6f358970815ecbbc40c6c28fb785ef6342da9a689713f99fece54f"
    ;;
    *)
      exit 1
    ;;
  esac
}

function update-patterns-cache {
  info 'Updating patterns cache...'
  auth_header="Authorization: Bearer $(cat "${auth_token_path}" | tr -d '\n')"
  patterns_url="${patterns_server}/patterns/gitleaks/${gitleaks_version}"

  # Allow this to fail
  set +e
  api_response="$(curl --fail -H "${auth_header}" "${patterns_url}" 2> /dev/null)"
  set -e

  if [[ -z "${api_response}" ]]
  then
    warn 'Pattern cache could not be refreshed.'
    debug "To see the error, run: curl -H \"Authorization: Bearer \$(cat "${auth_token_path}" | tr -d '\n')\" ${patterns_url}"

    if [[ ! -f "${gitleaks_patterns_path}" ]]
    then
      exit 1
    fi
  else
    echo "${api_response}" > "${gitleaks_patterns_path}"
    info 'Pattern cache updated'
  fi
}

# Enable proxy for preprod
if echo "${patterns_server}" | grep preprod &> /dev/null
then
  export https_proxy='http://squid.corp.redhat.com:3128'
fi

# Make sure the config and cache dirs exists
mkdir -p "${config_dir}"
mkdir -p "${cache_dir}"

# Fetch the right version of gitleaks
if [[ ! -f "${gitleaks_bin_path}" ]]
then
  info "Fetching gitleaks-${gitleaks_version}"
  curl -Lo "${gitleaks_bin_path}" "https://github.com/zricethezav/gitleaks/releases/download/v${gitleaks_version}/gitleaks-$(os-and-arch)" &> /dev/null

  if verify-checksum &> /dev/null
  then
    chmod +x "${gitleaks_bin_path}"
  else
    error "Could not validate checksum of ${gitleaks_bin_path}"
    info "Removing ${gitleaks_bin_path}"
    rm ${gitleaks_bin_path}
    exit 1
  fi
fi

info 'Checking patterns cache...'
if [[ ! -f "${auth_token_path}" ]]
then
  error "No Auth Token: auth_token_path=${auth_token_path}"
  info "Please go to ${patterns_server}/token to generate a token and place it at ${auth_token_path}"
  exit 2
fi

if ! find "${gitleaks_patterns_path}" -mmin "-${refresh_interval_min}" 2> /dev/null | grep . &> /dev/null
then
  info 'Patterns cache missing or outdated'
  update-patterns-cache
else
  info 'Patterns cache is up-to-date'
fi

exec "${gitleaks_bin_path}" "--config-path=${gitleaks_patterns_path}" $@

#! /bin/bash
set -euo pipefail

config_dir="${HOME}/.config/rh-gitleaks"
auth_token_path="${config_dir}/auth.jwt"
gitleaks_version="7.6.1"
gitleaks_bin_checksum="ab3d667982b2bfb00e846bd7b751c640216d2bbe0f71e2c53c4514ca415d99ec"
gitleaks_bin_path="${config_dir}/gitleaks-${gitleaks_version}"
gitleaks_config_path="${config_dir}/config.toml"
patterns_server="${RH_GITLEAKS_PATTERNS_SERVER:-https://patterns.security.redhat.com}"
refresh_interval_min='720'

function log {
  echo "$(date --iso-8601=seconds) [$1] $2" >&2
}

function error {
  log "ERROR" "$1"
}

function info {
  log "INFO" "$1"
}

function warn {
  log "WARN" "$1"
}

function update-patterns-cache {
  info 'Updating patterns cache...'
  auth_header="Authorization: Bearer $(cat "${auth_token_path}" | tr -d '\n')"
  patterns_url="${patterns_server}/patterns/gitleaks/${gitleaks_version}"

  # Allow this to fail
  set +e
  api_response="$(curl --fail-with-body -H "${auth_header}" "${patterns_url}" 2> /dev/null)"
  api_response_code="$?"
  set -e

  if [[ "${api_response_code}" -ne 0 ]]
  then
    warn 'Pattern cache could not be refreshed'
    error "${api_response}"
  else
    echo "${api_response}" > "${gitleaks_config_path}"
    info 'Pattern cache updated'
  fi
}

# Enable proxy for preprod
if echo "${patterns_server}" | grep preprod &> /dev/null
then
  export https_proxy='http://squid.corp.redhat.com:3128'
fi

# Make sure the config dir exists
mkdir -p "${config_dir}"

# Fetch the right version of gitleaks
if [[ ! -f "${gitleaks_bin_path}" ]]
then
  info "Pulling gitleaks-${gitleaks_version}"
  curl -Lo "${gitleaks_bin_path}" "https://github.com/zricethezav/gitleaks/releases/download/v${gitleaks_version}/gitleaks-linux-amd64" &> /dev/null

  if echo "${gitleaks_bin_checksum} ${gitleaks_bin_path}" | sha256sum -c - &> /dev/null
  then
    chmod +x "${gitleaks_bin_path}"
  else
    error "Could not validate checksum of ${gitleaks_bin_path}"
    info "Removing ${gitleaks_bin_path}"
    rm ${gitleaks_bin_path}
    exit 1
  fi
fi

info 'Checking patterns cache...'
if [[ ! -f "${auth_token_path}" ]]
then
  error "No Auth Token: auth_token_path=${auth_token_path}"
  info "Please go to ${patterns_server}/token to generate a token and place it at ${auth_token_path}"
  exit 2
fi

if ! find "${gitleaks_config_path}" -mmin "-${refresh_interval_min}" &> /dev/null
then
  info 'Patterns cache missing or outdated'
  update-patterns-cache
else
  info 'Patterns cache is up-to-date'
fi

exec "${gitleaks_bin_path}" "--config-path=${gitleaks_config_path}" $@

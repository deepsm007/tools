#! /bin/sh

set +x

export PYTHON="python3"
export PIP="$PYTHON -m pip"
export VENV_ROOT=$($PYTHON -c 'import sys; print("" if sys.base_prefix == sys.prefix else sys.prefix)')

if [ "$VENV_ROOT" != "" ]; then
  export USE_VENV="false"
fi

if [ "$USE_VENV" != "false" ]; then
  if ! [ -d venv ]; then
    $PYTHON -m venv venv
  fi

  # Confirm the CA cert exists and is not older than 1 hour
  if ! find ./venv/etc/pki/ca-trust/extracted/pem -name tls-ca-bundle.pem -mmin -60 | grep tls-ca-bundle.pem &> /dev/null; then
    ( # Use a subshell to avoid changing directories for the rest of the script
      mkdir -p ./venv/etc/pki/ca-trust/extracted/pem && \
      cd ./venv/etc/pki/ca-trust/extracted/pem && \
      curl -O https://nexus.corp.redhat.com/repository/infosec-raw/pki/tls-ca-bundle.pem && \
      curl -O https://nexus.corp.redhat.com/repository/infosec-raw/pki/tls-ca-bundle-checksum && \
      sha256sum -c tls-ca-bundle-checksum && rm tls-ca-bundle-checksum
    )
  fi

  # Configure the venv
  # https://pip.pypa.io/en/stable/topics/configuration/
  if [ -e ./scripts/vars/PIP_LINKS ]; then
    echo "# File auto generated by scripts/common
    [global]
    cert = $(pwd)/venv/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
    find-links = $(cat ./scripts/vars/PIP_LINKS)
    no-index = true
    " | sed -r 's/^\s+//g' > ./venv/pip.conf
  else
    echo "# File auto generated by scripts/common" > ./venv/pip.conf
  fi

  source ./venv/bin/activate
fi

# Set PIPFLAGS
#
# Some flags are set even though they are covered in the venv pip.conf above so
# that they apply during the container build and if the build was done outside
# of a venv. The reason they're still set in the pip.conf is so that IDEs
# pick up the config as well.

PIPFLAGS=""

if [ -e ./scripts/vars/PIP_LINKS ]
then
  PIPFLAGS="$PIPFLAGS --no-index --find-links $(cat ./scripts/vars/PIP_LINKS)"
fi

export PYTHONPATH="$(pwd)/src:$(pwd):$PYTHONPATH"
export PIP_INSTALL="$PIP install $PIPFLAGS"
export PIP_WHEEL="$PIP wheel $PIPFLAGS"
export COVERAGE="$PYTHON -m coverage"
export PYLINT="$PYTHON -m pylint"
export BANDIT="$PYTHON -m bandit"
export BLACK="$PYTHON -m black"
export OPEN_FILE="$(which xdg-open 2> /dev/null || which open 2> /dev/null || echo false)"
set -x
